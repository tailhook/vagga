#!/bin/sh -ex

: ${container_dir:=.vagga/work}
: ${workdir:=/work}

type lxc-usernsexec             # lxc, maybe get rid of it
type newuidmap newgidmap        # shadow >= 4.2
type mount pivot_root           # util-linux
type chroot                     # util-linux

if ! root=$(readlink -f "${container_dir}/root"); then
    echo "Dir $container_dir/root does not exists" 2>&1
    exit 1
fi

for dir in proc sys dev work tmp; do
    test -d $root/$dir || mkdir $root/$dir
done

export container_dir root workdir mount_dir=.vagga/mnt
test -d $mount_dir || mkdir -p $mount_dir

exec lxc-usernsexec -- \
    unshare --fork --mount --ipc --pid -- \
    /bin/sh -ex $(dirname $0)/vagga-chroot-inner "$@"
