name: Tests

on:
  push:
    branches:
      - master
      - ci
  pull_request:
    branches:
      - '*'

jobs:
  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 500

      - name: Install vagga
        run: |
          echo 'deb [arch=amd64 trusted=yes] https://ubuntu.zerogw.com vagga-testing main' | \
            sudo tee /etc/apt/sources.list.d/vagga.list
          sudo apt-get update
          sudo apt-get install -y vagga

      - uses: Swatinem/rust-cache@v1

      - name: Vagga tests cache
        uses: actions/cache@v2
        with:
          path: |
            tmp/cache
          key: vagga-cache-v1

      - name: Build and run tests
        env:
          UBUNTU_MIRROR: http://mirrors.us.kernel.org/ubuntu/
        run: |
          export VAGGA_SETTINGS="
            cache-dir: ${GITHUB_WORKSPACE}/tmp/cache
            external-volumes:
              cargo: ${HOME}/.cargo"
          vagga make-release-ci
          ./vagga -eUBUNTU_MIRROR test \
            -j 4 \
            --no-parallelize-within-files \
            --verbose-run \
            tests
